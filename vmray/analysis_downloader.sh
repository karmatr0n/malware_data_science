#!/bin/sh
api_url='https://<VMRayHOST>/rest'
api_key='YOUR_API_KEY'
auth_headers="Authorization: api_key $api_key"

dest_dir='data/sample_analysis'
mkdir -p $dest_dir

OLDIFS=$IFS

cat $1|
while IFS=',' read -r sample_sha256 analysis_type analysis_id; do
  sample_analysis_dir="${dest_dir}/${sample_sha256}/${analysis_type}/${analysis_id}"
  files=(function_calls.js data.js behavior.json)
  for file in ${files[@]}; do
    sample_analysis_url="${api_url}/analysis/${analysis_id}/archive?filename=report%2F${file}"
    mkdir -p $sample_analysis_dir
    sample_analysis="${sample_analysis_dir}/${file}"
    echo $sample_analysis_url
    curl -k -X GET -H "${auth_headers}" "${sample_analysis_url}" > $sample_analysis
    if [ "$?" -eq 0 ]; then
      echo "Saved at ${sample_analysis}"
    fi
  done
done 

IFS=$OLDIFS
