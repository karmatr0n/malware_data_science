import json
import os

from tqdm import tqdm
from vmray.rest_api import VMRayRESTAPI, VMRayRESTAPIError
from malware_data_sciece.config import Config

class SampleDowloader(Config):
  def download(self):
    for sample_type in self.vmray['sample_types']:
      samples = self.download_samples(sample_type) 
      if len(samples) > 0:
        self.save_as_json(sample_type, samples)

  def download_samples(self, sample_type):
    api = VMRayRESTAPI(self.vmray['server'], self.vmray['api_key'])
    try: 
      total_samples = api.call('GET', '/rest/sample/type/' + sample_type + '?_count=True')
    except VMRayRESTAPIError:
      total_samples = 0
    samples = []
    if total_samples > 0:
      min_id = 0
      with tqdm(total=total_samples, desc=sample_type) as pbar:
        while len(samples) < total_samples:
          try: 
            metadata = api.call('GET', '/rest/sample/type/' + sample_type + '?_limit=100&_order=asc&_min_id=' + str(min_id))
            samples += metadata 
            min_id = metadata[-1]['sample_id'] + 1
            pbar.update(len(samples))
          except VMRayRESTAPIError: 
            continue
    return samples

  def save_as_json(self, sample_type, samples):
    dest_dir = os.path.join(self.data_dir, 'sample_types')
    os.makedirs(dest_dir, exist_ok = True)
    file_path = os.path.join(dest_dir, sample_type + '.json')
    with open(file_path, 'w') as file:
      json.dump(samples, file, indent=4)

downloader = SampleDowloader()
downloader.download()
print('Done!')
