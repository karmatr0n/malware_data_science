#!/bin/sh
api_url='https://<VMRayHOST>/rest'
api_key='YOUR_API_KEY'
auth_headers="Authorization: api_key $api_key"

dest_dir='data/sample_files'
mkdir -p $dest_dir

db='db/malware_analysis.db'
sql='SELECT sample_id, sha256 FROM malware'

OLDIFS=$IFS

sqlite3 $db "$sql" |
while IFS='|' read -r sample_id sample_sha256; do
  echo "Downloading file for the ${sample_id} sample..."
  sample_file_url="${api_url}/sample/${sample_id}/file"
  sample_file="${dest_dir}/${sample_sha256}.zip"
  curl -# -k -X GET -H "$auth_headers" "${sample_file_url}" -o $sample_file
  if [ "$?" -eq 0 ]; then
    echo "Saved at ${sample_file}"
  fi
done 

IFS=$OLDIFS
