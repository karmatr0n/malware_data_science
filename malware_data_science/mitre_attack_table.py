import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import six

class MitreAttackTable:
  def __init__(self, tactics: dict, table_title: str):
    self.data_frame = pd.DataFrame()
    self.tactics = tactics
    self.table_title = table_title
  
  def build_data_frame(self) -> None:
    max_rows = max([len(self.tactics[tactic]) for tactic in self.tactics.keys()])
    for tactic in self.tactics.keys():
      a = list(self.tactics[tactic])
      if len(a) < max_rows:
        n = max_rows - len(a)
        i = 1
        while i <= n:
          a.append('')
          i += 1
      self.data_frame[tactic] = a
  
  def render_table(self, ax=None, **kwargs) -> None:
    col_width = 4.0
    row_height = 0.5
    font_size = 10
    header_color = '#086A87'
    row_colors = ['#f1f1f2', 'w']
    edge_color = 'w'
    bbox = [0, 0, 1, 1]
    header_columns = 0
    if ax is None:
      size = (np.array(self.data_frame.shape[::-1]) + \
              np.array([0, 1])) * \
              np.array([col_width, row_height])
      fig, ax = plt.subplots(figsize=size)
      ax.axis('off')

    mpl_table = ax.table(cellText=self.data_frame.values,
                         bbox=bbox,
                         colLabels=self.data_frame.columns,
                         loc='center',
                         **kwargs)
    mpl_table.auto_set_font_size(False)
    mpl_table.set_fontsize(font_size)

    for k, cell in six.iteritems(mpl_table._cells):
      cell.set_edgecolor(edge_color)
      if k[0] == 0 or k[1] < header_columns:
        cell.set_text_props(weight='bold', color='w')
        cell.set_facecolor(header_color)
      else:
        cell.set_facecolor(row_colors[k[0]%len(row_colors)])
        cell._loc = 'left'

  def save_fig(self, path: str) -> None:
    plt.savefig(path, format='png')
