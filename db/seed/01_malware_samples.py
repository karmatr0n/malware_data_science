import json
import os
import datetime
import re
import sys

sys.path.append(os.path.dirname(os.path.realpath(__file__))+'/../..')

from malware_data_science.config import Config
from malware_data_science.db import Malware, DB

config = Config()
src_dir = os.path.join(config.data_dir, 'sample_types')
attr = ['sample_id', 'sample_created', 'sample_sha256hash', 'sample_md5hash', 'sample_ssdeephash', 'sample_severity']
db = DB()
for filename in os.listdir(src_dir):
  file_path = os.path.join(src_dir, filename)
  sample_type = re.sub(r'.json$', '', filename)
  with open(file_path, 'r') as file:
    db_session = db.session
    for entry in json.load(file):
      if entry.get('sample_severity') not in ['not_suspicious', None, 'unknown']:
        if Malware.one_by_sha256(entry.get('sample_sha256hash')) == None:
          new_malware = Malware()
          new_malware.md5 = entry.get('sample_md5hash')
          new_malware.sha256 = entry.get('sample_sha256hash')
          new_malware.ssdeep_hash = entry.get('sample_ssdeephash')
          new_malware.created_at = datetime.datetime.strptime(entry.get('sample_created'), '%Y-%m-%dT%H:%M:%S')
          new_malware.sample_id = entry.get('sample_id')
          new_malware.sample_type = sample_type
          db.session.add(new_malware)
    db.session.commit()
